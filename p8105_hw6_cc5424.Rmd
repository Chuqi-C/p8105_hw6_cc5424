---
title: "p8105_hw6_cc5424"
author: "ChuqiChen"
date: "2025-12-03"
output: github_document
---
#problem1
```{r}
library(tidyverse)
library(broom)
library(ggplot2)

# 读入数据
homicides <- readr::read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")

# 创建 city_state
homicides <- homicides %>%
  mutate(city_state = paste(city, state, sep = ", "),
         victim_age = as.numeric(victim_age),
         solved = ifelse(disposition == "Closed by arrest", 1, 0))

# 过滤掉指定城市 & 限制种族
clean_dat <- homicides %>%
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>%
  filter(victim_race %in% c("White", "Black"))
```

```{r}
balt <- clean_dat %>% filter(city_state == "Baltimore, MD")

fit_balt <- glm(
  solved ~ victim_age + victim_sex + victim_race,
  data = balt,
  family = binomial
)

tidy_balt <- broom::tidy(fit_balt, conf.int = TRUE, exponentiate = TRUE)
male_OR_balt <- tidy_balt %>% filter(term == "victim_sexMale")

male_OR_balt
```

```{r}
# 每个城市运行 glm
models_by_city <- clean_dat %>%
  nest(data = -city_state) %>%
  mutate(
    model = map(data, ~ glm(
      solved ~ victim_age + victim_sex + victim_race,
      data = .x,
      family = binomial
    )),
    tidy = map(model, ~ broom::tidy(.x, conf.int = TRUE, exponentiate = TRUE))
  ) %>%
  select(city_state, tidy) %>%
  unnest(tidy) %>%
  filter(term == "victim_sexMale") %>%
  arrange(estimate)
```

```{r}
ggplot(models_by_city, aes(
  x = reorder(city_state, estimate),
  y = estimate,
  ymin = conf.low,
  ymax = conf.high
)) +
  geom_pointrange() +
  coord_flip() +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  labs(
    title = "Adjusted OR of Solved Homicides: Male vs Female Victims",
    x = "City",
    y = "Adjusted Odds Ratio (Male vs Female)"
  ) +
  theme_minimal()
```
Overall Trends

In many cities, the adjusted OR is below 1, indicating:
Cases involving male victims are less likely to be solved than those involving female victims in these cities (after adjusting for age and race).

Several cities show an OR significantly greater than 1 (e.g., Albuquerque, NM), suggesting:
Cases involving male victims are more likely to be solved.

Differences in Confidence Interval Width

Some cities exhibit very wide confidence intervals (particularly those with smaller samples), indicating unstable estimates.

Larger cities (e.g., Los Angeles, Chicago) have narrower CIs, suggesting more reliable estimates.

Baltimore's Position

Baltimore, MD's OR is significantly below 1 (approximately 0.7), indicating:
In Baltimore, cases involving male victims are harder to solve, even after controlling for age and race.

Significant Cross-City Variation

ORs vary considerably across cities, indicating:
Solving rates are influenced by structural factors such as city resources, judicial systems, and policing practices, not solely by victim characteristics.



#problem2
```{r}
library(p8105.datasets)

data("weather_df")
```

```{r}
boot_sample <- function(df) {
  df_boot <- df %>% sample_frac(replace = TRUE)
  
  fit <- lm(tmax ~ tmin + prcp, data = df_boot)
  
  r2 <- glance(fit)$r.squared
  
  coefs <- tidy(fit)
  beta1 <- coefs %>% filter(term == "tmin") %>% pull(estimate)
  beta2 <- coefs %>% filter(term == "prcp") %>% pull(estimate)
  
  ratio <- beta1 / beta2
  
  tibble(r2 = r2, ratio = ratio)
}
```

```{r}
set.seed(123)

boot_results <- 
  tibble(i = 1:5000) %>%
  mutate(est = map(i, ~ boot_sample(weather_df))) %>%
  unnest(est)
```

```{r}
ggplot(boot_results, aes(x = r2)) +
  geom_histogram(bins = 50, fill = "skyblue", color = "black") +
  labs(
    title = "Bootstrap Distribution of R-squared",
    x = "R-squared",
    y = "Count"
  ) +
  theme_minimal()
```

```{r}
ggplot(boot_results, aes(x = ratio)) +
  geom_histogram(bins = 50, fill = "orange", color = "black") +
  labs(
    title = "Bootstrap Distribution of β̂₁ / β̂₂",
    x = "β̂₁ / β̂₂",
    y = "Count"
  ) +
  theme_minimal()
```

```{r}
boot_results %>% 
  summarize(
    r2_lower = quantile(r2, 0.025),
    r2_upper = quantile(r2, 0.975)
  )
```

```{r}
boot_results %>% 
  summarize(
    ratio_lower = quantile(ratio, 0.025, na.rm = TRUE),
    ratio_upper = quantile(ratio, 0.975, na.rm = TRUE)
  )
```
The bootstrap distribution of R² is highly concentrated and approximately normal, with a mean around 0.94 and a very narrow distribution, indicating that the model fit remains highly stable during resampling.

The bootstrap distribution of β₁/β₂ exhibits a more pronounced right skew and longer tails, suggesting that this ratio is relatively unstable, influenced by the small and highly variable prcp coefficient.



#problem3
```{r}
# Load packages
library(tidyverse)
library(modelr)
library(broom)
library(janitor)

# Load and clean the data
birthweight =
  read_csv("./data/birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    babysex = factor(babysex, levels = c(1,2), labels = c("male","female")),
    frace   = factor(frace, levels = c(1,2,3,4,8,9),
                     labels = c("White","Black","Asian","Puerto Rican","Other","Unknown")),
    malform = factor(malform, levels = c(0,1), labels = c("absent","present")),
    mrace   = factor(mrace, levels = c(1,2,3,4,8),
                     labels = c("White","Black","Asian","Puerto Rican","Other"))
  )

# Check missing data
sum(is.na(birthweight))

# Main model (biology + parental characteristics)
# NOTE: delwt = ppwt + wtgain  → wtgain is dropped due to collinearity
bwt_reg =
  lm(bwt ~ delwt + frace + mheight + momage + mrace + ppwt + wtgain,
     data = birthweight)

summary(bwt_reg)
broom::glance(bwt_reg)
broom::tidy(bwt_reg)

# Residuals vs Fitted Plot
birthweight %>% 
  add_predictions(bwt_reg) %>% 
  add_residuals(bwt_reg) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.4) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(
    title = "Residuals vs Fitted Values",
    x = "Fitted Values",
    y = "Residuals"
  ) +
  theme_minimal()

# Comparison models

# Model 1: blength + gaweeks (main effects only)
reg_1 =
  lm(bwt ~ blength + gaweeks, data = birthweight)

# Model 2: Three-way interaction among bhead * blength * babysex
reg_2 =
  lm(bwt ~ bhead * blength * babysex, data = birthweight)

# Compare model residuals visually
birthweight %>% 
  gather_predictions(bwt_reg, reg_1, reg_2) %>% 
  gather_residuals(bwt_reg, reg_1, reg_2) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.4) +
  facet_grid(~ model) +
  labs(
    title = "Model Residual Comparison",
    x = "Predicted birthweight",
    y = "Residuals"
  ) +
  theme_minimal()

# Monte Carlo Cross-Validation (100 splits)
set.seed(123)

cv_df =
  crossv_mc(birthweight, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test  = map(test, as_tibble)
  ) %>% 
  mutate(
    # Fit all 3 models
    bwt_reg = map(train,
                  \(df) lm(bwt ~ delwt + frace + mheight + momage + mrace + ppwt + wtgain,
                          data = df)),
    reg_1   = map(train,
                  \(df) lm(bwt ~ blength + gaweeks, data = df)),
    reg_2   = map(train,
                  \(df) lm(bwt ~ bhead * blength * babysex, data = df))
  ) %>% 
  mutate(
    # Compute RMSE for each
    rmse_bwt_reg = map2_dbl(bwt_reg, test, \(mod, df) rmse(model = mod, data = df)),
    rmse_reg_1   = map2_dbl(reg_1,   test, \(mod, df) rmse(model = mod, data = df)),
    rmse_reg_2   = map2_dbl(reg_2,   test, \(mod, df) rmse(model = mod, data = df))
  ) %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  mutate(model = fct_inorder(model))

# Cross-validation RMSE comparison plot
cv_plot =
  cv_df %>% 
  ggplot(aes(x = model, y = rmse)) +
  geom_violin(fill = "skyblue") +
  labs(
    title = "Cross-Validated Prediction Error Comparison",
    x = "Models",
    y = "RMSE"
  ) +
  theme_minimal()

cv_plot
```


